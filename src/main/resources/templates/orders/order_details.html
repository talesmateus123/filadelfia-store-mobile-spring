<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Pedido - Filadelfia Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <div th:replace="layout :: header"></div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2>Detalhes do Pedido</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/orders/my">Meus Pedidos</a></li>
                        <li class="breadcrumb-item active" aria-current="page" th:text="${order.orderNumber}">Pedido</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
        <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>

        <div class="row" th:if="${order}">
            <!-- Order Information -->
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Pedido #<span th:text="${order.orderNumber}"></span></h5>
                        <span class="badge" th:classappend="${order.status.name() == 'PENDING' ? 'bg-warning' : 
                                                        order.status.name() == 'CONFIRMED' ? 'bg-info' : 
                                                        order.status.name() == 'SHIPPED' ? 'bg-primary' : 
                                                        order.status.name() == 'DELIVERED' ? 'bg-success' : 
                                                        order.status.name() == 'CANCELLED' ? 'bg-danger' : 'bg-secondary'}"
                              th:text="${order.status.name() == 'PENDING' ? 'Pendente' : 
                                       order.status.name() == 'CONFIRMED' ? 'Confirmado' : 
                                       order.status.name() == 'SHIPPED' ? 'Enviado' : 
                                       order.status.name() == 'DELIVERED' ? 'Entregue' : 
                                       order.status.name() == 'CANCELLED' ? 'Cancelado' : order.status}"></span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Data do Pedido:</strong> <span th:text="${#dates.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                                <p><strong>Método de Pagamento:</strong> 
                                    <span th:text="${order.paymentMethod.name() == 'CREDIT_CARD' ? 'Cartão de Crédito' : 
                                                   order.paymentMethod.name() == 'DEBIT_CARD' ? 'Cartão de Débito' : 
                                                   order.paymentMethod.name() == 'PIX' ? 'PIX' : 
                                                   order.paymentMethod.name() == 'BANK_SLIP' ? 'Boleto Bancário' : order.paymentMethod}"></span>
                                </p>
                                <p><strong>Pagamento Confirmado:</strong> 
                                    <span th:if="${order.paymentConfirmed}" class="text-success">Sim</span>
                                    <span th:unless="${order.paymentConfirmed}" class="text-warning">Pendente</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p th:if="${order.shippedAt}"><strong>Data de Envio:</strong> <span th:text="${#dates.format(order.shippedAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                                <p th:if="${order.deliveredAt}"><strong>Data de Entrega:</strong> <span th:text="${#dates.format(order.deliveredAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                                <p th:if="${order.trackingCode}"><strong>Código de Rastreamento:</strong> <span th:text="${order.trackingCode}"></span></p>
                            </div>
                        </div>
                        
                        <div th:if="${order.notes}">
                            <hr>
                            <p><strong>Observações:</strong></p>
                            <p th:text="${order.notes}"></p>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="card">
                    <div class="card-header">
                        <h5>Itens do Pedido</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Quantidade</th>
                                        <th>Preço Unitário</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="item : ${order.items}">
                                        <td th:text="${item.productName}"></td>
                                        <td th:text="${item.quantity}"></td>
                                        <td th:text="'R$ ' + ${#numbers.formatDecimal(item.unitPrice, 1, 2)}"></td>
                                        <td th:text="'R$ ' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}"></td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3">Subtotal:</th>
                                        <th th:text="'R$ ' + ${#numbers.formatDecimal(order.subtotal, 1, 2)}"></th>
                                    </tr>
                                    <tr th:if="${order.shippingCost != null and order.shippingCost > 0}">
                                        <th colspan="3">Frete:</th>
                                        <th th:text="'R$ ' + ${#numbers.formatDecimal(order.shippingCost, 1, 2)}"></th>
                                    </tr>
                                    <tr class="table-success">
                                        <th colspan="3">Total:</th>
                                        <th th:text="'R$ ' + ${#numbers.formatDecimal(order.total, 1, 2)}"></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions and Shipping -->
            <div class="col-md-4">
                <!-- Actions -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Ações</h5>
                    </div>
                    <div class="card-body">
                        <!-- Cancel Order (for users) -->
                        <div th:if="${canCancel}">
                            <form th:action="@{/orders/{id}/cancel(id=${order.id})}" method="post" 
                                  onsubmit="return confirm('Tem certeza que deseja cancelar este pedido?')">
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="fas fa-times"></i> Cancelar Pedido
                                </button>
                            </form>
                            <hr>
                        </div>

                        <!-- Admin/Manager Actions -->
                        <div sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">
                            <h6>Gerenciar Pedido:</h6>
                            
                            <!-- Update Status -->
                            <form th:action="@{/orders/{id}/status(id=${order.id})}" method="post" class="mb-2">
                                <div class="input-group input-group-sm">
                                    <select name="status" class="form-select">
                                        <option value="PENDING" th:selected="${order.status.name() == 'PENDING'}">Pendente</option>
                                        <option value="CONFIRMED" th:selected="${order.status.name() == 'CONFIRMED'}">Confirmado</option>
                                        <option value="SHIPPED" th:selected="${order.status.name() == 'SHIPPED'}">Enviado</option>
                                        <option value="DELIVERED" th:selected="${order.status.name() == 'DELIVERED'}">Entregue</option>
                                        <option value="CANCELLED" th:selected="${order.status.name() == 'CANCELLED'}">Cancelado</option>
                                    </select>
                                    <button type="submit" class="btn btn-outline-primary btn-sm">Atualizar</button>
                                </div>
                            </form>

                            <!-- Confirm Payment -->
                            <form th:if="${!order.paymentConfirmed}" th:action="@{/orders/{id}/payment/confirm(id=${order.id})}" method="post" class="mb-2">
                                <button type="submit" class="btn btn-success btn-sm w-100">
                                    <i class="fas fa-check"></i> Confirmar Pagamento
                                </button>
                            </form>

                            <!-- Fulfill Order -->
                            <form th:if="${order.status.name() == 'CONFIRMED'}" th:action="@{/orders/{id}/fulfill(id=${order.id})}" method="post">
                                <button type="submit" class="btn btn-primary btn-sm w-100">
                                    <i class="fas fa-shipping-fast"></i> Enviar Pedido
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="card">
                    <div class="card-header">
                        <h5>Endereço de Entrega</h5>
                    </div>
                    <div class="card-body">
                        <address>
                            <span th:text="${order.shippingStreet + ', ' + order.shippingNumber}"></span><br>
                            <span th:if="${order.shippingComplement}" th:text="${order.shippingComplement}"></span><br th:if="${order.shippingComplement}">
                            <span th:text="${order.shippingNeighborhood}"></span><br>
                            <span th:text="${order.shippingCity + ' - ' + order.shippingState}"></span><br>
                            <span th:text="'CEP: ' + ${order.shippingZipCode}"></span>
                        </address>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <a href="/orders/my" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar aos Pedidos
                </a>
            </div>
        </div>
    </div>

    <div th:replace="layout :: footer"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
</body>
</html>
