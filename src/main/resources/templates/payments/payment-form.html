<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Filadelfia Store</title>
    <div th:replace="~{layout :: head}"></div>
    <style>
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .payment-method {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .payment-method:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        
        .payment-method.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .payment-method-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .card-form, .pix-form, .boleto-form {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #f8fafc;
        }
        
        .order-summary {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .summary-row.total {
            font-weight: bold;
            font-size: 1.2rem;
            border-top: 1px solid #cbd5e1;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div th:replace="~{layout :: header}"></div>
    
    <div th:replace="~{layout :: notifications}"></div>
    
    <main class="container">
        <div class="content-wrapper">
            <div class="page-header">
                <h1>Finalizar Pagamento</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/}">Início</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/orders}">Pedidos</a></li>
                        <li class="breadcrumb-item active">Pagamento</li>
                    </ol>
                </nav>
            </div>

            <!-- Error Messages -->
            <div th:if="${error}" class="alert alert-danger" role="alert">
                <i class="ion-alert-circled"></i>
                <span th:text="${error}"></span>
            </div>

            <!-- Success Messages -->
            <div th:if="${success}" class="alert alert-success" role="alert">
                <i class="ion-checkmark-circled"></i>
                <span th:text="${success}"></span>
            </div>

            <div class="row">
                <!-- Order Summary -->
                <div class="col-md-4">
                    <div class="order-summary">
                        <h3>Resumo do Pedido</h3>
                        <div class="summary-row">
                            <span>Pedido #</span>
                            <span th:text="${order.orderNumber}"></span>
                        </div>
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span th:text="${order.formattedSubtotal}"></span>
                        </div>
                        <div class="summary-row">
                            <span>Frete:</span>
                            <span th:text="${order.formattedShippingCost}"></span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span th:text="${order.formattedTotal}"></span>
                        </div>
                        
                        <!-- Order Items -->
                        <div class="order-items">
                            <h4>Itens do Pedido</h4>
                            <div th:each="item : ${order.items}" class="order-item">
                                <div class="item-info">
                                    <span class="item-name" th:text="${item.product.name}"></span>
                                    <span class="item-quantity" th:text="'Qtd: ' + ${item.quantity}"></span>
                                    <span class="item-price" th:text="${item.formattedSubtotal}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Form -->
                <div class="col-md-8">
                    <div class="payment-form-container">
                        <h2>Escolha a Forma de Pagamento</h2>
                        
                        <form th:action="@{/payments/process}" th:object="${paymentDTO}" method="post" id="paymentForm">
                            <input type="hidden" th:field="*{orderId}" />
                            <input type="hidden" th:field="*{amount}" />
                            
                            <!-- Payment Methods Selection -->
                            <div class="payment-methods">
                                <div th:each="method : ${paymentMethods}" 
                                     class="payment-method" 
                                     th:data-method="${method.name()}"
                                     onclick="selectPaymentMethod(this)">
                                    <span class="payment-method-icon">
                                        <i th:class="${method == T(com.filadelfia.store.filadelfiastore.model.enums.PaymentMethod).CREDIT_CARD ? 'ion-card' : 
                                                       method == T(com.filadelfia.store.filadelfiastore.model.enums.PaymentMethod).PIX ? 'ion-flash' :
                                                       method == T(com.filadelfia.store.filadelfiastore.model.enums.PaymentMethod).BOLETO ? 'ion-document-text' :
                                                       method == T(com.filadelfia.store.filadelfiastore.model.enums.PaymentMethod).CASH ? 'ion-cash' : 'ion-card'}"></i>
                                    </span>
                                    <h4 th:text="${method.displayName}"></h4>
                                    <p th:text="${method.description}" class="text-muted small"></p>
                                </div>
                            </div>
                            
                            <input type="hidden" th:field="*{paymentMethod}" id="selectedPaymentMethod" />
                            
                            <!-- Credit/Debit Card Form -->
                            <div id="cardForm" class="card-form">
                                <h4>Dados do Cartão</h4>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="cardHolderName">Nome no Cartão *</label>
                                            <input type="text" th:field="*{cardHolderName}" class="form-control" 
                                                   placeholder="Nome como está no cartão" maxlength="100" />
                                            <span th:if="${#fields.hasErrors('cardHolderName')}" 
                                                  th:errors="*{cardHolderName}" class="text-danger small"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="cardNumber">Número do Cartão *</label>
                                            <input type="text" id="cardNumber" class="form-control" 
                                                   placeholder="0000 0000 0000 0000" maxlength="19"
                                                   onkeyup="formatCardNumber(this)" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="cardBrand">Bandeira</label>
                                            <input type="text" th:field="*{cardBrand}" class="form-control" 
                                                   id="cardBrand" readonly />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="cardExpiry">Validade *</label>
                                            <input type="text" id="cardExpiry" class="form-control" 
                                                   placeholder="MM/AA" maxlength="5"
                                                   onkeyup="formatExpiry(this)" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="cardCvc">CVC *</label>
                                            <input type="text" id="cardCvc" class="form-control" 
                                                   placeholder="123" maxlength="4" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="cardLastFourDigits">Últimos 4 dígitos</label>
                                            <input type="text" th:field="*{cardLastFourDigits}" class="form-control" 
                                                   id="cardLastFourDigits" readonly />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PIX Form -->
                            <div id="pixForm" class="pix-form">
                                <h4>Pagamento via PIX</h4>
                                <div class="alert alert-info">
                                    <i class="ion-information-circled"></i>
                                    Após confirmar, você receberá um QR Code para realizar o pagamento via PIX.
                                    O pagamento deve ser realizado em até 30 minutos.
                                </div>
                                <div class="form-group">
                                    <label for="pixKey">Chave PIX (opcional)</label>
                                    <input type="text" th:field="*{pixKey}" class="form-control" 
                                           placeholder="Sua chave PIX para identificação" />
                                    <small class="form-text text-muted">
                                        Se você possui uma chave PIX, pode informá-la para facilitar a identificação do pagamento.
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Boleto Form -->
                            <div id="boletoForm" class="boleto-form">
                                <h4>Pagamento via Boleto</h4>
                                <div class="alert alert-warning">
                                    <i class="ion-alert-circled"></i>
                                    O boleto será gerado após a confirmação e terá vencimento em 3 dias úteis.
                                    Após o pagamento, pode levar até 2 dias úteis para a confirmação.
                                </div>
                            </div>
                            
                            <!-- Bank Transfer Form -->
                            <div id="bankTransferForm" class="boleto-form">
                                <h4>Transferência Bancária</h4>
                                <div class="alert alert-info">
                                    <i class="ion-information-circled"></i>
                                    Após confirmar, você receberá os dados bancários para realizar a transferência.
                                    Envie o comprovante para acelerar a confirmação do pagamento.
                                </div>
                            </div>
                            
                            <!-- Cash Form -->
                            <div id="cashForm" class="boleto-form">
                                <h4>Pagamento em Dinheiro</h4>
                                <div class="alert alert-success">
                                    <i class="ion-cash"></i>
                                    O pagamento será realizado na entrega do produto.
                                    Tenha o valor exato em mãos no momento da entrega.
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="history.back()">
                                    <i class="ion-arrow-left-c"></i> Voltar
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitPayment" disabled>
                                    <i class="ion-card"></i> Finalizar Pagamento
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div th:replace="~{layout :: footer}"></div>
    <div th:replace="~{layout :: scripts}"></div>
    
    <script>
        function selectPaymentMethod(element) {
            // Remove selection from all methods
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to clicked method
            element.classList.add('selected');
            
            // Get method name and set hidden field
            const method = element.getAttribute('data-method');
            document.getElementById('selectedPaymentMethod').value = method;
            
            // Hide all forms
            document.querySelectorAll('.card-form, .pix-form, .boleto-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Show relevant form
            if (method === 'CREDIT_CARD' || method === 'DEBIT_CARD') {
                document.getElementById('cardForm').style.display = 'block';
            } else if (method === 'PIX') {
                document.getElementById('pixForm').style.display = 'block';
            } else if (method === 'BOLETO') {
                document.getElementById('boletoForm').style.display = 'block';
            } else if (method === 'BANK_TRANSFER') {
                document.getElementById('bankTransferForm').style.display = 'block';
            } else if (method === 'CASH') {
                document.getElementById('cashForm').style.display = 'block';
            }
            
            // Enable submit button
            document.getElementById('submitPayment').disabled = false;
        }
        
        function formatCardNumber(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            input.value = value;
            
            // Extract last 4 digits
            const lastFour = value.replace(/\s/g, '').slice(-4);
            document.getElementById('cardLastFourDigits').value = lastFour;
            
            // Detect card brand
            const cardBrand = detectCardBrand(value.replace(/\s/g, ''));
            document.getElementById('cardBrand').value = cardBrand;
        }
        
        function formatExpiry(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            input.value = value;
        }
        
        function detectCardBrand(number) {
            if (number.startsWith('4')) return 'Visa';
            if (number.startsWith('5') || number.startsWith('2')) return 'Mastercard';
            if (number.startsWith('3')) return 'American Express';
            if (number.startsWith('6')) return 'Elo';
            return 'Desconhecida';
        }
        
        // Form validation
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            const method = document.getElementById('selectedPaymentMethod').value;
            const submitButton = this.querySelector('button[type="submit"]');
            
            if (!method) {
                e.preventDefault();
                showError('Por favor, selecione uma forma de pagamento.');
                return;
            }
            
            if (method === 'CREDIT_CARD' || method === 'DEBIT_CARD') {
                const cardNumber = document.getElementById('cardNumber').value;
                const cardHolderName = document.querySelector('input[name="cardHolderName"]').value;
                const cardExpiry = document.getElementById('cardExpiry').value;
                const cardCvc = document.getElementById('cardCvc').value;
                
                if (!cardNumber || !cardHolderName || !cardExpiry || !cardCvc) {
                    e.preventDefault();
                    showError('Por favor, preencha todos os dados do cartão.');
                    return;
                }
                
                if (cardNumber.replace(/\s/g, '').length < 13) {
                    e.preventDefault();
                    showError('Número do cartão inválido.');
                    return;
                }
                
                // Check expiry date
                const [month, year] = cardExpiry.split('/');
                const currentDate = new Date();
                const cardDate = new Date('20' + year, month - 1);
                
                if (cardDate <= currentDate) {
                    e.preventDefault();
                    showError('Cartão vencido. Verifique a data de validade.');
                    return;
                }
            }
            
            // Show loading state
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '⏳ Processando...';
            }
        });
        
        function showError(message) {
            // Remove existing error messages
            const existingErrors = document.querySelectorAll('.error-message');
            existingErrors.forEach(error => error.remove());
            
            // Create and show new error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.cssText = `
                background-color: #fee2e2;
                color: #991b1b;
                padding: 1rem;
                border-radius: 4px;
                margin: 1rem 0;
                border: 1px solid #fecaca;
            `;
            errorDiv.textContent = message;
            
            const form = document.getElementById('paymentForm');
            form.insertBefore(errorDiv, form.firstChild);
            
            // Scroll to error message
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
