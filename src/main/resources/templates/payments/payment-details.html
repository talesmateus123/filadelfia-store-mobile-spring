<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Pagamento - Filadelfia Store</title>
    <div th:replace="~{layout :: head}"></div>
    <style>
        .payment-status {
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .payment-status.pending {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .payment-status.confirmed {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .payment-status.failed {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .payment-details {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .payment-info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .payment-info-row:last-child {
            border-bottom: none;
        }
        
        .payment-info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .payment-info-value {
            color: #6b7280;
        }
        
        .pix-code-container {
            background-color: #ffffff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin: 1rem 0;
        }
        
        .pix-qr-code {
            background-color: #ffffff;
            padding: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            word-break: break-all;
            margin: 0.5rem 0;
        }
        
        .boleto-info {
            background-color: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .countdown-timer {
            background-color: #fef2f2;
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin: 1rem 0;
        }
        
        .timer-display {
            font-size: 2rem;
            font-weight: bold;
            color: #dc2626;
            margin: 0.5rem 0;
        }
        
        .copy-button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .copy-button:hover {
            background-color: #2563eb;
        }
        
        .order-summary {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div th:replace="~{layout :: header}"></div>
    
    <main class="container">
        <div class="content-wrapper">
            <div class="page-header">
                <h1>Detalhes do Pagamento</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/}">Início</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/payments/history}">Pagamentos</a></li>
                        <li class="breadcrumb-item active">Detalhes</li>
                    </ol>
                </nav>
            </div>

            <!-- Error Messages -->
            <div th:if="${error}" class="alert alert-danger" role="alert">
                <i class="ion-alert-circled"></i>
                <span th:text="${error}"></span>
            </div>

            <!-- Success Messages -->
            <div th:if="${success}" class="alert alert-success" role="alert">
                <i class="ion-checkmark-circled"></i>
                <span th:text="${success}"></span>
            </div>

            <div class="row">
                <!-- Payment Status -->
                <div class="col-12">
                    <div class="payment-status" 
                         th:classappend="${payment.status.isSuccessful() ? 'confirmed' : 
                                         payment.status.hasFailed() ? 'failed' : 'pending'}">
                        <h2>
                            <i th:class="${payment.status.isSuccessful() ? 'ion-checkmark-circled' : 
                                          payment.status.hasFailed() ? 'ion-close-circled' : 'ion-clock'}"></i>
                            <span th:text="${payment.status.displayName}">Status</span>
                        </h2>
                        <p th:text="${payment.status.description}">Descrição do status</p>
                        
                        <!-- Countdown timer for expiring payments -->
                        <div th:if="${payment.status.isInProgress() && payment.expiresAt != null}" 
                             class="countdown-timer">
                            <h4>Tempo restante para pagamento:</h4>
                            <div class="timer-display" id="countdown">--:--</div>
                            <p class="small text-muted">
                                Expira em: <span th:text="${#temporals.format(payment.expiresAt, 'dd/MM/yyyy HH:mm')}"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Payment Details -->
                <div class="col-md-8">
                    <div class="payment-details">
                        <h3>Informações do Pagamento</h3>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">ID da Transação:</span>
                            <span class="payment-info-value" th:text="${payment.transactionId}"></span>
                        </div>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">Forma de Pagamento:</span>
                            <span class="payment-info-value" th:text="${payment.paymentMethod.displayName}"></span>
                        </div>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">Valor:</span>
                            <span class="payment-info-value" th:text="${payment.formattedAmount}"></span>
                        </div>
                        
                        <div class="payment-info-row" th:if="${payment.processingFee != null && payment.processingFee.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
                            <span class="payment-info-label">Taxa de Processamento:</span>
                            <span class="payment-info-value" th:text="'R$ ' + ${#numbers.formatDecimal(payment.processingFee, 1, 2)}"></span>
                        </div>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">Data de Criação:</span>
                            <span class="payment-info-value" th:text="${#temporals.format(payment.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                        </div>
                        
                        <div class="payment-info-row" th:if="${payment.confirmedAt != null}">
                            <span class="payment-info-label">Data de Confirmação:</span>
                            <span class="payment-info-value" th:text="${#temporals.format(payment.confirmedAt, 'dd/MM/yyyy HH:mm')}"></span>
                        </div>
                        
                        <!-- Card Information -->
                        <div th:if="${payment.cardLastFourDigits != null}" class="payment-info-row">
                            <span class="payment-info-label">Cartão:</span>
                            <span class="payment-info-value" th:text="${payment.cardBrand + ' final ' + payment.cardLastFourDigits}"></span>
                        </div>
                        
                        <!-- Gateway Information -->
                        <div th:if="${payment.gatewayTransactionId != null}" class="payment-info-row">
                            <span class="payment-info-label">ID do Gateway:</span>
                            <span class="payment-info-value" th:text="${payment.gatewayTransactionId}"></span>
                        </div>
                        
                        <!-- Failure Reason -->
                        <div th:if="${payment.failureReason != null}" class="payment-info-row">
                            <span class="payment-info-label">Motivo da Falha:</span>
                            <span class="payment-info-value text-danger" th:text="${payment.failureReason}"></span>
                        </div>
                        
                        <!-- Notes -->
                        <div th:if="${payment.notes != null}" class="payment-info-row">
                            <span class="payment-info-label">Observações:</span>
                            <span class="payment-info-value" th:text="${payment.notes}"></span>
                        </div>
                    </div>

                    <!-- PIX Payment Instructions -->
                    <div th:if="${showPixCode && payment.pixQrCode != null}" class="pix-code-container">
                        <h3><i class="ion-flash"></i> Pagamento via PIX</h3>
                        <p>Escaneie o QR Code abaixo ou copie o código PIX:</p>
                        
                        <!-- QR Code (placeholder - in production, you'd generate an actual QR code image) -->
                        <div class="pix-qr-code">
                            <p><strong>QR Code:</strong></p>
                            <p th:text="${payment.pixQrCode}"></p>
                        </div>
                        
                        <!-- Copy-Paste PIX Code -->
                        <div class="pix-copy-paste">
                            <label><strong>Código PIX Copia e Cola:</strong></label>
                            <div class="input-group">
                                <input type="text" class="form-control" th:value="${payment.pixCopyPaste}" 
                                       id="pixCopyPaste" readonly />
                                <button class="copy-button" onclick="copyToClipboard('pixCopyPaste')">
                                    <i class="ion-copy"></i> Copiar
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="ion-information-circled"></i>
                            <strong>Instruções:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Abra o app do seu banco</li>
                                <li>Vá para a área PIX</li>
                                <li>Escaneie o QR Code ou cole o código</li>
                                <li>Confirme o pagamento</li>
                                <li>O pedido será confirmado automaticamente</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Boleto Payment Instructions -->
                    <div th:if="${showBoletoInfo && payment.boletoNumber != null}" class="boleto-info">
                        <h3><i class="ion-document-text"></i> Boleto Bancário</h3>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">Número do Boleto:</span>
                            <span class="payment-info-value" th:text="${payment.boletoNumber}"></span>
                        </div>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">Código de Barras:</span>
                            <span class="payment-info-value font-monospace" th:text="${payment.boletoBarcode}"></span>
                        </div>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">Vencimento:</span>
                            <span class="payment-info-value" th:text="${#temporals.format(payment.boletoDueDate, 'dd/MM/yyyy')}"></span>
                        </div>
                        
                        <div class="mt-3">
                            <a th:href="${payment.boletoUrl}" target="_blank" class="btn btn-primary">
                                <i class="ion-document"></i> Visualizar Boleto
                            </a>
                            <button class="copy-button" onclick="copyToClipboard('boletoBarcode')">
                                <i class="ion-copy"></i> Copiar Código de Barras
                            </button>
                        </div>
                        
                        <input type="hidden" th:value="${payment.boletoBarcode}" id="boletoBarcode" />
                        
                        <div class="alert alert-warning mt-3">
                            <i class="ion-alert-circled"></i>
                            <strong>Instruções:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Imprima o boleto ou anote o código de barras</li>
                                <li>Pague em qualquer banco, lotérica ou app bancário</li>
                                <li>O pagamento pode levar até 2 dias úteis para ser confirmado</li>
                                <li>Não pague após a data de vencimento</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="col-md-4">
                    <div class="order-summary">
                        <h3>Pedido #<span th:text="${order.orderNumber}"></span></h3>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">Status do Pedido:</span>
                            <span class="payment-info-value">
                                <span class="badge" th:classappend="${order.status.name().toLowerCase()}" 
                                      th:text="${order.status.displayName}"></span>
                            </span>
                        </div>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">Total do Pedido:</span>
                            <span class="payment-info-value" th:text="${order.formattedTotal}"></span>
                        </div>
                        
                        <div class="payment-info-row">
                            <span class="payment-info-label">Data do Pedido:</span>
                            <span class="payment-info-value" th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy')}"></span>
                        </div>
                        
                        <!-- Order Items -->
                        <div class="mt-3">
                            <h4>Itens do Pedido</h4>
                            <div th:each="item : ${order.items}" class="payment-info-row">
                                <span class="payment-info-label" th:text="${item.product.name + ' (x' + item.quantity + ')'}"></span>
                                <span class="payment-info-value" th:text="${item.formattedSubtotal}"></span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <a th:href="@{/orders/{id}(id=${order.id})}" class="btn btn-outline-primary btn-sm">
                                <i class="ion-eye"></i> Ver Pedido Completo
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="text-center">
                        <a th:href="@{/orders}" class="btn btn-secondary">
                            <i class="ion-arrow-left-c"></i> Voltar aos Pedidos
                        </a>
                        <a th:href="@{/payments/history}" class="btn btn-outline-primary">
                            <i class="ion-card"></i> Histórico de Pagamentos
                        </a>
                        
                        <!-- Retry payment button for failed payments -->
                        <a th:if="${payment.status.hasFailed()}" 
                           th:href="@{/payments/order/{orderId}(orderId=${order.id})}" 
                           class="btn btn-warning">
                            <i class="ion-refresh"></i> Tentar Novamente
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div th:replace="~{layout :: footer}"></div>
    <div th:replace="~{layout :: scripts}"></div>
    
    <script th:if="${payment.expiresAt != null}">
        // Countdown timer for payment expiration
        const expiresAt = new Date([[${payment.expiresAt}]]);
        
        function updateCountdown() {
            const now = new Date();
            const timeLeft = expiresAt - now;
            
            if (timeLeft <= 0) {
                document.getElementById('countdown').innerHTML = 'EXPIRADO';
                // Reload page to update status
                setTimeout(() => location.reload(), 2000);
                return;
            }
            
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            
            document.getElementById('countdown').innerHTML = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Update countdown every second
        setInterval(updateCountdown, 1000);
        updateCountdown(); // Initial call
    </script>
    
    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                alert('Copiado para a área de transferência!');
            } catch (err) {
                alert('Erro ao copiar. Selecione e copie manualmente.');
            }
        }
        
        // Auto-refresh page for pending payments every 30 seconds
        [[${payment.status.isInProgress()}]] && setInterval(() => {
            if (!document.hidden) {
                location.reload();
            }
        }, 30000);
    </script>
</body>
</html>
