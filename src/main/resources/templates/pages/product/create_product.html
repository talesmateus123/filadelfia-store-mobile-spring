<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout :: head}">
</head>
<body>
    <header th:replace="~{layout :: header}">
    </header>

    <div class="container">
        <div id="produtos" class="tab-content active">
            <h2 class="section-title" th:text="${pageTitle}"></h2>
            
            <div class="form-container" th:if="${productDTO != null}">
                <form id="form-produto"
                    th:object="${productDTO}"
                    th:action="${isEdit} ? @{/products/edit/{id}(id=*{id})} : @{/products/create}"
                    method="post"
                    enctype="multipart/form-data">
                    <input type="hidden" id="produto-id" name="id" th:field="*{id}" th:if="${isEdit}">
                    <div class="form-group">
                        <label for="produto-nome">Nome do Produto</label>
                        <input type="text" id="produto-nome" th:field="*{name}" required>
                    </div>
                    <div class="form-group">
                        <label for="produto-descricao">Descrição:</label>
                        <textarea id="produto-descricao" th:field="*{description}" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="produto-categoria">Categoria</label>
                        <select id="produto-categoria" th:field="*{categoryId}" required>
                            <option value="">Selecione uma categoria</option>
                            <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="produto-preco">Preço (R$)</label>
                        <input type="number" id="produto-preco" th:field="*{price}" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="produto-estoque">Quantidade em Estoque</label>
                        <input type="number" id="produto-estoque" th:field="*{stock}" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="produto-ativo">Ativo</label>
                        <input type="checkbox" id="produto-ativo" th:field="*{active}" checked>
                    </div>
                    
                    <!-- Product Image Upload -->
                    <div class="form-group">
                        <label for="produto-imagem">Imagem do Produto</label>
                        <input type="file" 
                               id="produto-imagem" 
                               name="imageFile" 
                               accept="image/*" 
                               class="file-input"
                               onchange="previewImageCreate(this)">
                        <small class="form-text">
                            Formatos aceitos: JPG, PNG, GIF, WEBP (máximo 5MB)
                        </small>
                        
                        <!-- Current Image Display (for edit mode) -->
                        <div th:if="${isEdit != null and isEdit and productDTO != null and productDTO.imageUrl != null and not #strings.isEmpty(productDTO.imageUrl)}" 
                             class="current-image-display">
                            <p>Imagem atual:</p>
                            <img th:src="${productDTO.imageUrl}" 
                                 th:alt="${productDTO.name}" 
                                 class="current-product-image">
                        </div>
                        
                        <!-- Image Preview -->
                        <div id="imagePreviewCreate" class="image-preview" style="display: none;">
                            <img id="previewImgCreate" src="" alt="Preview">
                            <p>Preview da nova imagem</p>
                        </div>
                    </div>

                   <div th:replace="~{layout :: notifications}"></div>
                   
                   <!-- Display validation errors -->
                   <div th:if="${#fields.hasAnyErrors()}" class="alert alert-danger">
                       <ul>
                           <li th:each="error : ${#fields.allErrors()}" th:text="${error}"></li>
                       </ul>
                   </div>
                   
                   <!-- Display error message -->
                   <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

                    <div class="form-actions">
                        <button type="button" id="btn-cancelar" class="danger" onclick="history.back()">Cancelar</button>
                        <button type="submit" id="btn-salvar" class="success">Salvar Produto</button>
                    </div>
                </form>
            </div>
            
        </div>
    </div>

    <footer th:replace="~{layout :: footer}">
    </footer>
    
    <div th:replace="~{common/modal :: modal-manager}">
    </div>

    <div th:replace="~{layout :: scripts}">
    </div>
    
    <!-- Image Preview JavaScript for Create/Edit -->
    <script>
        function previewImageCreate(input) {
            const preview = document.getElementById('imagePreviewCreate');
            const previewImg = document.getElementById('previewImgCreate');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
                previewImg.src = '';
            }
        }
    </script>
    
</body>
</html>